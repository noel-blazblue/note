# 协调

> 协程和线程并不一样，协程本身是没有并发或者并行能力的（需要配合线程），它只是一种控制流程的让出机制
>

 **🔴React 渲染的过程可以被中断，可以将控制权交回浏览器，让位给高优先级的任务，浏览器空闲后再恢复渲染**。 

它由几部分组成：
 - [[时间分片]]
 - [[fiber]] fiber结构与diff手段



## 阶段划分

 ![img](https://user-gold-cdn.xitu.io/2019/10/21/16deecd830671a70?imageView2/0/w/1280/h/960/format/webp/ignore-error/1) 

 每次渲染有两个阶段：`Reconciliation`(协调阶段) 和 `Commit`(提交阶段). 

- **⚛️ 协调阶段**: 可以认为是 [[fiber#Diff |Diff]] 阶段, **这个阶段可以被中断**, 这个阶段会找出所有节点变更，例如节点新增、删除、属性变更等等, 这些变更React 称之为'`副作用`(Effect)' . 以下生命周期钩子会在协调阶段被调用：
  - `constructor`
  - `componentWillMount`  废弃
  - `componentWillReceiveProps` 废弃
  - `static getDerivedStateFromProps` 
  - `shouldComponentUpdate`
  - `componentWillUpdate` 废弃
  - `render`
  - `getSnapshotBeforeUpdate()`
- **⚛️ 提交阶段**: 将上一个阶段计算出来的需要处理的**副作用(Effects)**一次性执行了。**这个阶段必须同步执行，不能被打断**. 这些生命周期钩子在提交阶段被执行:
  - `componentDidMount`
  - `componentDidUpdate`
  - `componentWillUnmount`



 协调阶段可能被中断、恢复，甚至重做，**⚠️React 协调阶段的生命周期钩子可能会被调用多次!**, 例如 `componentWillMount` 可能会被调用两次。 

 ## 双缓冲

 `WIP 树`构建这种技术类似于图形化领域的'**双缓存(Double Buffering)**'技术, 图形绘制引擎一般会使用双缓冲技术，先将图片绘制到一个缓冲区，再一次性传递给屏幕进行显示，这样可以防止屏幕抖动，优化渲染性能。 

放到React 中，WIP树就是一个缓冲，它在Reconciliation 完毕后一次性提交给浏览器进行渲染。它可以减少内存分配和垃圾回收，WIP 的节点不完全是新的，比如某颗子树不需要变动，React会克隆复用旧树中的子树。

双缓存技术还有另外一个重要的场景就是异常的处理，比如当一个节点抛出异常，仍然可以继续沿用旧树的节点，避免整棵树挂掉。