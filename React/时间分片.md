æ—¶é—´åˆ†ç‰‡æ˜¯ä¸€ç§æ¸²æŸ“ä¸Šçš„ä¼˜åŒ–æ‰‹æ®µï¼Œäººçœ¼èƒ½æ„ŸçŸ¥åˆ°çš„æœ€ä½é™åº¦ä¸ºæ¯ç§’60å¸§ï¼Œæ¯å¸§ä¸º16msï¼Œreactä»¥requestIdleCallBackçš„å½¢å¼ï¼Œåœ¨æµè§ˆå™¨çš„ç»˜åˆ¶ä»»åŠ¡å®Œæˆåçš„ä¸€å¸§ä¸­çš„ç›ˆä½™æ—¶é—´ï¼Œä»¥[[Fiber]]ä¸ºåŸºæœ¬å·¥ä½œå•å…ƒä¸æ–­çš„å¾ªç¯æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶åœ¨æ¯ä¸€æ¬¡ä»»åŠ¡ç»“æŸååˆ¤æ–­ä¸€ä¸‹æ˜¯å¦å‰©ä½™æ—¶é—´æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœè¶³å¤Ÿåˆ™ç»§ç»­ä¸‹ä¸€æ¬¡ä»»åŠ¡ï¼Œå¦åˆ™ä¸­æ–­ä»»åŠ¡ç»™è®©å‡ºæ§åˆ¶æƒï¼Œå¹¶åœ¨ä¸‹ä¸€æ¬¡è°ƒåº¦ä¸­æ¢å¤ä¸Šä¸€ä¸ªä»»åŠ¡ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™æäº¤æ›´æ–°ã€‚ ^0d95c0

![img](https://user-gold-cdn.xitu.io/2019/10/21/16deecc37fdd60d7?imageView2/0/w/1280/h/960/format/webp/ignore-error/1) 



###  **requestIdleCallback** 

 *ç¡®å®šä¸€ä¸ªåˆç†çš„è¿è¡Œæ—¶é•¿ï¼Œç„¶ååœ¨åˆé€‚çš„æ£€æŸ¥ç‚¹æ£€æµ‹æ˜¯å¦è¶…æ—¶(æ¯”å¦‚æ¯æ‰§è¡Œä¸€ä¸ªå°ä»»åŠ¡)ï¼Œå¦‚æœè¶…æ—¶å°±åœæ­¢æ‰§è¡Œï¼Œå°†æ§åˆ¶æƒäº¤æ¢ç»™æµè§ˆå™¨*ã€‚ 

 ä¸ºäº†è®©è§†å›¾æµç•…åœ°è¿è¡Œï¼Œå¯ä»¥æŒ‰ç…§äººç±»èƒ½æ„ŸçŸ¥åˆ°æœ€ä½é™åº¦æ¯ç§’60å¸§çš„é¢‘ç‡åˆ’åˆ†æ—¶é—´ç‰‡ï¼Œè¿™æ ·æ¯ä¸ªæ—¶é—´ç‰‡å°±æ˜¯ 16msã€‚ 

1å¸§ = 16ms  (1000ms / 60) 

```
window.requestIdleCallback(
  callback: (dealine: IdleDeadline) => void,
  option?: {timeout: number}
  )
```



`IdleDeadline`çš„æ¥å£å¦‚ä¸‹ï¼š

```
interface IdleDealine {
  didTimeout: boolean // è¡¨ç¤ºä»»åŠ¡æ‰§è¡Œæ˜¯å¦è¶…è¿‡çº¦å®šæ—¶é—´
  timeRemaining(): DOMHighResTimeStamp // ä»»åŠ¡å¯ä¾›æ‰§è¡Œçš„å‰©ä½™æ—¶é—´
}
```



 **æµè§ˆå™¨åœ¨ä¸€å¸§å†…å¯èƒ½ä¼šåšæ‰§è¡Œä¸‹åˆ—ä»»åŠ¡ï¼Œè€Œä¸”å®ƒä»¬çš„æ‰§è¡Œé¡ºåºåŸºæœ¬æ˜¯å›ºå®šçš„:** 

- å¤„ç†ç”¨æˆ·è¾“å…¥äº‹ä»¶
- Javascriptæ‰§è¡Œ
- requestAnimation è°ƒç”¨
- å¸ƒå±€ Layout
- ç»˜åˆ¶ Paint



 å¦‚æœæµè§ˆå™¨å¤„ç†å®Œä¸Šè¿°çš„ä»»åŠ¡(å¸ƒå±€å’Œç»˜åˆ¶ä¹‹å)ï¼Œè¿˜æœ‰ç›ˆä½™æ—¶é—´ï¼Œæµè§ˆå™¨å°±ä¼šè°ƒç”¨ `requestIdleCallback` çš„å›è°ƒ 

 ![img](https://user-gold-cdn.xitu.io/2019/10/21/16deecc43c710e16?imageView2/0/w/1280/h/960/format/webp/ignore-error/1) 



**ä½†æ˜¯åœ¨æµè§ˆå™¨ç¹å¿™çš„æ—¶å€™ï¼Œå¯èƒ½ä¸ä¼šæœ‰ç›ˆä½™æ—¶é—´ï¼Œè¿™æ—¶å€™`requestIdleCallback`å›è°ƒå¯èƒ½å°±ä¸ä¼šè¢«æ‰§è¡Œã€‚ ä¸ºäº†é¿å…é¥¿æ­»ï¼Œå¯ä»¥é€šè¿‡requestIdleCallbackçš„ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šä¸€ä¸ªè¶…æ—¶æ—¶é—´**ã€‚

> å¦å¤–ä¸å»ºè®®åœ¨`requestIdleCallback`ä¸­è¿›è¡Œ`DOM`æ“ä½œï¼Œå› ä¸ºè¿™å¯èƒ½å¯¼è‡´æ ·å¼é‡æ–°è®¡ç®—æˆ–é‡æ–°å¸ƒå±€(æ¯”å¦‚æ“ä½œDOMåé©¬ä¸Šè°ƒç”¨ `getBoundingClientRect`)ï¼Œè¿™äº›æ—¶é—´å¾ˆéš¾é¢„ä¼°çš„ï¼Œå¾ˆæœ‰å¯èƒ½å¯¼è‡´å›è°ƒæ‰§è¡Œè¶…æ—¶ï¼Œä»è€Œæ‰å¸§ã€‚



ç›®å‰ `requestIdleCallback` ç›®å‰åªæœ‰Chromeæ”¯æŒã€‚æ‰€ä»¥ç›®å‰ React [è‡ªå·±å®ç°äº†ä¸€ä¸ª](https://github.com/facebook/react/blob/master/packages/scheduler/src/forks/SchedulerHostConfig.default.js)ã€‚å®ƒåˆ©ç”¨[`MessageChannel`](https://developer.mozilla.org/zh-CN/docs/Web/API/MessageChannel) æ¨¡æ‹Ÿå°†å›è°ƒå»¶è¿Ÿåˆ°'ç»˜åˆ¶æ“ä½œ'ä¹‹åæ‰§è¡Œ:



### `MessageChannel`

å› ä¸º`requestIdleCallback`è¿™ä¸ª API ç›®å‰è¿˜å¤„äºè‰æ¡ˆé˜¶æ®µï¼Œæ‰€ä»¥æµè§ˆå™¨å®ç°ç‡è¿˜ä¸é«˜ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œ React ç›´æ¥ä½¿ç”¨äº†`polyfill`çš„æ–¹æ¡ˆã€‚

è¿™ä¸ªæ–¹æ¡ˆç®€å•æ¥è¯´æ˜¯é€šè¿‡`requestAnimationFrame`åœ¨æµè§ˆå™¨æ¸²æŸ“ä¸€å¸§ä¹‹å‰åšä¸€äº›å¤„ç†ï¼Œç„¶åé€šè¿‡`postMessage`åœ¨`macro task`ï¼ˆç±»ä¼¼ setTimeoutï¼‰ä¸­åŠ å…¥ä¸€ä¸ªå›è°ƒï¼Œåœ¨å› ä¸ºæ¥ä¸‹å»ä¼šè¿›å…¥æµè§ˆå™¨æ¸²æŸ“é˜¶æ®µï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹æ˜¯è¢« block ä½çš„ï¼Œç­‰åˆ°æ¸²æŸ“å®Œäº†ç„¶åå›æ¥æ¸…ç©º`macro task`ã€‚
https://react.jokcy.me/book/flow/scheduler-pkg.html

```js
const el = document.getElementById('root')
const btn = document.getElementById('btn')
const ch = new MessageChannel()
let pendingCallback
let startTime
let timeout

ch.port2.onmessage = function work()  {
  // åœ¨ç»˜åˆ¶ä¹‹åè¢«æ‰§è¡Œ
  if (pendingCallback) {
    const now = performance.now()
    // é€šè¿‡now - startTimeå¯ä»¥è®¡ç®—å‡ºrequestAnimationFrameåˆ°ç»˜åˆ¶ç»“æŸçš„æ‰§è¡Œæ—¶é—´
    // é€šè¿‡è¿™äº›æ•°æ®æ¥è®¡ç®—å‰©ä½™æ—¶é—´
    // å¦å¤–è¿˜è¦å¤„ç†è¶…æ—¶(timeout)ï¼Œé¿å…ä»»åŠ¡è¢«é¥¿æ­»
    // ...
    if (hasRemain && noTimeout) {
      pendingCallback(deadline)
    }
  }
}

// ...

function simpleRequestIdleCallback(callback, timeout) {
  requestAnimationFrame(function animation() {
    // åœ¨ç»˜åˆ¶ä¹‹å‰è¢«æ‰§è¡Œ
    // è®°å½•å¼€å§‹æ—¶é—´
    startTime = performance.now()
    timeout = timeout
    dosomething()
    // è°ƒåº¦å›è°ƒåˆ°ç»˜åˆ¶ç»“æŸåæ‰§è¡Œ
    pendingCallback = callback
    ch.port1.postMessage('hello')
  })
}

```



####  **ä»»åŠ¡ä¼˜å…ˆçº§** 

 ä¸ºäº†é¿å…ä»»åŠ¡è¢«é¥¿æ­»ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´. **è¿™ä¸ªè¶…æ—¶æ—¶é—´ä¸æ˜¯æ­»çš„ï¼Œä½ä¼˜å…ˆçº§çš„å¯ä»¥æ…¢æ…¢ç­‰å¾…, é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡åº”è¯¥ç‡å…ˆè¢«æ‰§è¡Œ**. ç›®å‰ React é¢„å®šä¹‰äº† 5 ä¸ªä¼˜å…ˆçº§ ï¼š

- `Immediate`(-1) - è¿™ä¸ªä¼˜å…ˆçº§çš„ä»»åŠ¡ä¼šåŒæ­¥æ‰§è¡Œ, æˆ–è€…è¯´è¦é©¬ä¸Šæ‰§è¡Œä¸”ä¸èƒ½ä¸­æ–­
- `UserBlocking`(250ms) è¿™äº›ä»»åŠ¡ä¸€èˆ¬æ˜¯ç”¨æˆ·äº¤äº’çš„ç»“æœ, éœ€è¦å³æ—¶å¾—åˆ°åé¦ˆ
- `Normal` (5s) åº”å¯¹å“ªäº›ä¸éœ€è¦ç«‹å³æ„Ÿå—åˆ°çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ç½‘ç»œè¯·æ±‚
- `Low` (10s) è¿™äº›ä»»åŠ¡å¯ä»¥æ”¾åï¼Œä½†æ˜¯æœ€ç»ˆåº”è¯¥å¾—åˆ°æ‰§è¡Œ. ä¾‹å¦‚åˆ†æé€šçŸ¥
- `Idle` (æ²¡æœ‰è¶…æ—¶æ—¶é—´) ä¸€äº›æ²¡æœ‰å¿…è¦åšçš„ä»»åŠ¡ (e.g. æ¯”å¦‚éšè—çš„å†…å®¹), å¯èƒ½ä¼šè¢«é¥¿æ­»



#### å·¥ä½œå•å…ƒ

æ¯ä¸€ä¸ª[[Fiber]]éƒ½æ˜¯ä¸€ä¸ª **å·¥ä½œå•å…ƒ** 



 å‡è®¾ç”¨æˆ·è°ƒç”¨ `setState` æ›´æ–°ç»„ä»¶, è¿™ä¸ªå¾…æ›´æ–°çš„ä»»åŠ¡ä¼šå…ˆæ”¾å…¥é˜Ÿåˆ—ä¸­, ç„¶åé€šè¿‡ `requestIdleCallback` è¯·æ±‚æµè§ˆå™¨è°ƒåº¦ï¼š 

```js
updateQueue.push(updateTask);
requestIdleCallback(performWork, {timeout});
```



 ç°åœ¨æµè§ˆå™¨æœ‰ç©ºé—²æˆ–è€…è¶…æ—¶äº†å°±ä¼šè°ƒç”¨`performWork`æ¥æ‰§è¡Œä»»åŠ¡ï¼š 

```js
// 1ï¸âƒ£ performWork ä¼šæ‹¿åˆ°ä¸€ä¸ªDeadlineï¼Œè¡¨ç¤ºå‰©ä½™æ—¶é—´
function performWork(deadline) {

  // 2ï¸âƒ£ å¾ªç¯å–å‡ºupdateQueueä¸­çš„ä»»åŠ¡
  while (updateQueue.length > 0 && deadline.timeRemaining() > ENOUGH_TIME) {
    workLoop(deadline);
  }

  // 3ï¸âƒ£ å¦‚æœåœ¨æœ¬æ¬¡æ‰§è¡Œä¸­ï¼Œæœªèƒ½å°†æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œé‚£å°±å†è¯·æ±‚æµè§ˆå™¨è°ƒåº¦
  if (updateQueue.length > 0) {
    requestIdleCallback(performWork);
  }
}
```



 **`workLoop`  å®ƒä¼šä»æ›´æ–°é˜Ÿåˆ—(updateQueue)ä¸­å¼¹å‡ºæ›´æ–°ä»»åŠ¡æ¥æ‰§è¡Œï¼Œæ¯æ‰§è¡Œå®Œä¸€ä¸ªâ€˜`æ‰§è¡Œå•å…ƒ`â€˜ï¼Œå°±æ£€æŸ¥ä¸€ä¸‹å‰©ä½™æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœå……è¶³å°±è¿›è¡Œæ‰§è¡Œä¸‹ä¸€ä¸ª`æ‰§è¡Œå•å…ƒ`ï¼Œåä¹‹åˆ™åœæ­¢æ‰§è¡Œï¼Œä¿å­˜ç°åœºï¼Œç­‰ä¸‹ä¸€æ¬¡æœ‰æ‰§è¡Œæƒæ—¶æ¢å¤**: 

```js
// ä¿å­˜å½“å‰çš„å¤„ç†ç°åœº
let nextUnitOfWork: Fiber | undefined // ä¿å­˜ä¸‹ä¸€ä¸ªéœ€è¦å¤„ç†çš„å·¥ä½œå•å…ƒ
let topWork: Fiber | undefined        // ä¿å­˜ç¬¬ä¸€ä¸ªå·¥ä½œå•å…ƒ

function workLoop(deadline: IdleDeadline) {
  // updateQueueä¸­è·å–ä¸‹ä¸€ä¸ªæˆ–è€…æ¢å¤ä¸Šä¸€æ¬¡ä¸­æ–­çš„æ‰§è¡Œå•å…ƒ
  if (nextUnitOfWork == null) {
    nextUnitOfWork = topWork = getNextUnitOfWork();
  }

  // ğŸ”´ æ¯æ‰§è¡Œå®Œä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼Œæ£€æŸ¥ä¸€æ¬¡å‰©ä½™æ—¶é—´
  // å¦‚æœè¢«ä¸­æ–­ï¼Œä¸‹ä¸€æ¬¡æ‰§è¡Œè¿˜æ˜¯ä» nextUnitOfWork å¼€å§‹å¤„ç†
  while (nextUnitOfWork && deadline.timeRemaining() > ENOUGH_TIME) {
    // ä¸‹æ–‡æˆ‘ä»¬å†çœ‹performUnitOfWork
    nextUnitOfWork = performUnitOfWork(nextUnitOfWork, topWork);
  }

  // æäº¤å·¥ä½œï¼Œä¸‹æ–‡ä¼šä»‹ç»
  if (pendingCommit) {
    commitAllWork(pendingCommit);
  }
}
```



 ![img](https://user-gold-cdn.xitu.io/2019/10/21/16deed1711f281b3?imageslim) 

